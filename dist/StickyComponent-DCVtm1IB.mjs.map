{"version":3,"file":"StickyComponent-DCVtm1IB.mjs","sources":["../src/themes/StickyEditorTheme.ts","../src/nodes/StickyComponent.tsx"],"sourcesContent":["/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n */\n\nimport type {EditorThemeClasses} from 'lexical';\n\nimport './StickyEditorTheme.css';\n\nimport baseTheme from './PlaygroundEditorTheme';\n\nconst theme: EditorThemeClasses = {\n  ...baseTheme,\n  paragraph: 'StickyEditorTheme__paragraph',\n};\n\nexport default theme;\n","/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n */\n\nimport type {LexicalEditor, NodeKey} from 'lexical';\nimport type {JSX} from 'react';\n\nimport './StickyNode.css';\n\nimport {useCollaborationContext} from '@lexical/react/LexicalCollaborationContext';\nimport {CollaborationPlugin} from '@lexical/react/LexicalCollaborationPlugin';\nimport {useLexicalComposerContext} from '@lexical/react/LexicalComposerContext';\nimport {LexicalErrorBoundary} from '@lexical/react/LexicalErrorBoundary';\nimport {HistoryPlugin} from '@lexical/react/LexicalHistoryPlugin';\nimport {LexicalNestedComposer} from '@lexical/react/LexicalNestedComposer';\nimport {PlainTextPlugin} from '@lexical/react/LexicalPlainTextPlugin';\nimport {calculateZoomLevel} from '@lexical/utils';\nimport {$getNodeByKey} from 'lexical';\nimport * as React from 'react';\nimport {useEffect, useLayoutEffect, useRef} from 'react';\n\nimport {createWebsocketProvider} from '../collaboration';\nimport {useSharedHistoryContext} from '../context/SharedHistoryContext';\nimport StickyEditorTheme from '../themes/StickyEditorTheme';\nimport ContentEditable from '../ui/ContentEditable';\nimport {$isStickyNode} from './StickyNode';\n\ntype Positioning = {\n  isDragging: boolean;\n  offsetX: number;\n  offsetY: number;\n  rootElementRect: null | ClientRect;\n  x: number;\n  y: number;\n};\n\nfunction positionSticky(\n  stickyElem: HTMLElement,\n  positioning: Positioning,\n): void {\n  const style = stickyElem.style;\n  const rootElementRect = positioning.rootElementRect;\n  const rectLeft = rootElementRect !== null ? rootElementRect.left : 0;\n  const rectTop = rootElementRect !== null ? rootElementRect.top : 0;\n  style.top = rectTop + positioning.y + 'px';\n  style.left = rectLeft + positioning.x + 'px';\n}\n\nexport default function StickyComponent({\n  x,\n  y,\n  nodeKey,\n  color,\n  caption,\n}: {\n  caption: LexicalEditor;\n  color: 'pink' | 'yellow';\n  nodeKey: NodeKey;\n  x: number;\n  y: number;\n}): JSX.Element {\n  const [editor] = useLexicalComposerContext();\n  const stickyContainerRef = useRef<null | HTMLDivElement>(null);\n  const positioningRef = useRef<Positioning>({\n    isDragging: false,\n    offsetX: 0,\n    offsetY: 0,\n    rootElementRect: null,\n    x: 0,\n    y: 0,\n  });\n  const {isCollabActive} = useCollaborationContext();\n\n  useEffect(() => {\n    const position = positioningRef.current;\n    position.x = x;\n    position.y = y;\n\n    const stickyContainer = stickyContainerRef.current;\n    if (stickyContainer !== null) {\n      positionSticky(stickyContainer, position);\n    }\n  }, [x, y]);\n\n  useLayoutEffect(() => {\n    const position = positioningRef.current;\n    const resizeObserver = new ResizeObserver((entries) => {\n      for (let i = 0; i < entries.length; i++) {\n        const entry = entries[i];\n        const {target} = entry;\n        position.rootElementRect = target.getBoundingClientRect();\n        const stickyContainer = stickyContainerRef.current;\n        if (stickyContainer !== null) {\n          positionSticky(stickyContainer, position);\n        }\n      }\n    });\n\n    const removeRootListener = editor.registerRootListener(\n      (nextRootElem, prevRootElem) => {\n        if (prevRootElem !== null) {\n          resizeObserver.unobserve(prevRootElem);\n        }\n        if (nextRootElem !== null) {\n          resizeObserver.observe(nextRootElem);\n        }\n      },\n    );\n\n    const handleWindowResize = () => {\n      const rootElement = editor.getRootElement();\n      const stickyContainer = stickyContainerRef.current;\n      if (rootElement !== null && stickyContainer !== null) {\n        position.rootElementRect = rootElement.getBoundingClientRect();\n        positionSticky(stickyContainer, position);\n      }\n    };\n\n    window.addEventListener('resize', handleWindowResize);\n\n    return () => {\n      window.removeEventListener('resize', handleWindowResize);\n      removeRootListener();\n    };\n  }, [editor]);\n\n  useEffect(() => {\n    const stickyContainer = stickyContainerRef.current;\n    if (stickyContainer !== null) {\n      // Delay adding transition so we don't trigger the\n      // transition on load of the sticky.\n      setTimeout(() => {\n        stickyContainer.style.setProperty(\n          'transition',\n          'top 0.3s ease 0s, left 0.3s ease 0s',\n        );\n      }, 500);\n    }\n  }, []);\n\n  const handlePointerMove = (event: PointerEvent) => {\n    const stickyContainer = stickyContainerRef.current;\n    const positioning = positioningRef.current;\n    const rootElementRect = positioning.rootElementRect;\n    const zoom = calculateZoomLevel(stickyContainer);\n    if (\n      stickyContainer !== null &&\n      positioning.isDragging &&\n      rootElementRect !== null\n    ) {\n      positioning.x =\n        event.pageX / zoom - positioning.offsetX - rootElementRect.left;\n      positioning.y =\n        event.pageY / zoom - positioning.offsetY - rootElementRect.top;\n      positionSticky(stickyContainer, positioning);\n    }\n  };\n\n  const handlePointerUp = (event: PointerEvent) => {\n    const stickyContainer = stickyContainerRef.current;\n    const positioning = positioningRef.current;\n    if (stickyContainer !== null) {\n      positioning.isDragging = false;\n      stickyContainer.classList.remove('dragging');\n      editor.update(() => {\n        const node = $getNodeByKey(nodeKey);\n        if ($isStickyNode(node)) {\n          node.setPosition(positioning.x, positioning.y);\n        }\n      });\n    }\n    document.removeEventListener('pointermove', handlePointerMove);\n    document.removeEventListener('pointerup', handlePointerUp);\n  };\n\n  const handleDelete = () => {\n    editor.update(() => {\n      const node = $getNodeByKey(nodeKey);\n      if ($isStickyNode(node)) {\n        node.remove();\n      }\n    });\n  };\n\n  const handleColorChange = () => {\n    editor.update(() => {\n      const node = $getNodeByKey(nodeKey);\n      if ($isStickyNode(node)) {\n        node.toggleColor();\n      }\n    });\n  };\n\n  const {historyState} = useSharedHistoryContext();\n\n  return (\n    <div ref={stickyContainerRef} className=\"sticky-note-container\">\n      <div\n        className={`sticky-note ${color}`}\n        onPointerDown={(event) => {\n          const stickyContainer = stickyContainerRef.current;\n          if (\n            stickyContainer == null ||\n            event.button === 2 ||\n            event.target !== stickyContainer.firstChild\n          ) {\n            // Right click or click on editor should not work\n            return;\n          }\n          const stickContainer = stickyContainer;\n          const positioning = positioningRef.current;\n          if (stickContainer !== null) {\n            const {top, left} = stickContainer.getBoundingClientRect();\n            const zoom = calculateZoomLevel(stickContainer);\n            positioning.offsetX = event.clientX / zoom - left;\n            positioning.offsetY = event.clientY / zoom - top;\n            positioning.isDragging = true;\n            stickContainer.classList.add('dragging');\n            document.addEventListener('pointermove', handlePointerMove);\n            document.addEventListener('pointerup', handlePointerUp);\n            event.preventDefault();\n          }\n        }}>\n        <button\n          onClick={handleDelete}\n          className=\"delete\"\n          aria-label=\"Delete sticky note\"\n          title=\"Delete\">\n          X\n        </button>\n        <button\n          onClick={handleColorChange}\n          className=\"color\"\n          aria-label=\"Change sticky note color\"\n          title=\"Color\">\n          <i className=\"bucket\" />\n        </button>\n        <LexicalNestedComposer\n          initialEditor={caption}\n          initialTheme={StickyEditorTheme}>\n          {isCollabActive ? (\n            <CollaborationPlugin\n              id={caption.getKey()}\n              providerFactory={createWebsocketProvider}\n              shouldBootstrap={true}\n            />\n          ) : (\n            <HistoryPlugin externalHistoryState={historyState} />\n          )}\n          <PlainTextPlugin\n            contentEditable={\n              <ContentEditable\n                placeholder=\"What's up?\"\n                placeholderClassName=\"StickyNode__placeholder\"\n                className=\"StickyNode__contentEditable\"\n              />\n            }\n            ErrorBoundary={LexicalErrorBoundary}\n          />\n        </LexicalNestedComposer>\n      </div>\n    </div>\n  );\n}\n"],"names":["theme","baseTheme","positionSticky","stickyElem","positioning","style","rootElementRect","rectLeft","rectTop","StickyComponent","x","y","nodeKey","color","caption","editor","useLexicalComposerContext","stickyContainerRef","useRef","positioningRef","isCollabActive","useCollaborationContext","useEffect","position","stickyContainer","useLayoutEffect","resizeObserver","entries","entry","target","removeRootListener","nextRootElem","prevRootElem","handleWindowResize","rootElement","handlePointerMove","event","zoom","calculateZoomLevel","handlePointerUp","node","$getNodeByKey","$isStickyNode","handleDelete","handleColorChange","historyState","useSharedHistoryContext","jsx","jsxs","stickContainer","top","left","LexicalNestedComposer","StickyEditorTheme","CollaborationPlugin","createWebsocketProvider","HistoryPlugin","PlainTextPlugin","ContentEditable","LexicalErrorBoundary"],"mappings":"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"}