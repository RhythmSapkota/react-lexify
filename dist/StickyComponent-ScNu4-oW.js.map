{"version":3,"file":"StickyComponent-ScNu4-oW.js","sources":["../src/themes/StickyEditorTheme.ts","../src/nodes/StickyComponent.tsx"],"sourcesContent":["/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n */\n\nimport type {EditorThemeClasses} from 'lexical';\n\nimport './StickyEditorTheme.css';\n\nimport baseTheme from './PlaygroundEditorTheme';\n\nconst theme: EditorThemeClasses = {\n  ...baseTheme,\n  paragraph: 'StickyEditorTheme__paragraph',\n};\n\nexport default theme;\n","/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n */\n\nimport type {LexicalEditor, NodeKey} from 'lexical';\nimport type {JSX} from 'react';\n\nimport './StickyNode.css';\n\nimport {useCollaborationContext} from '@lexical/react/LexicalCollaborationContext';\nimport {CollaborationPlugin} from '@lexical/react/LexicalCollaborationPlugin';\nimport {useLexicalComposerContext} from '@lexical/react/LexicalComposerContext';\nimport {LexicalErrorBoundary} from '@lexical/react/LexicalErrorBoundary';\nimport {HistoryPlugin} from '@lexical/react/LexicalHistoryPlugin';\nimport {LexicalNestedComposer} from '@lexical/react/LexicalNestedComposer';\nimport {PlainTextPlugin} from '@lexical/react/LexicalPlainTextPlugin';\nimport {calculateZoomLevel} from '@lexical/utils';\nimport {$getNodeByKey} from 'lexical';\nimport * as React from 'react';\nimport {useEffect, useLayoutEffect, useRef} from 'react';\n\nimport {createWebsocketProvider} from '../collaboration';\nimport {useSharedHistoryContext} from '../context/SharedHistoryContext';\nimport StickyEditorTheme from '../themes/StickyEditorTheme';\nimport ContentEditable from '../ui/ContentEditable';\nimport {$isStickyNode} from './StickyNode';\n\ntype Positioning = {\n  isDragging: boolean;\n  offsetX: number;\n  offsetY: number;\n  rootElementRect: null | ClientRect;\n  x: number;\n  y: number;\n};\n\nfunction positionSticky(\n  stickyElem: HTMLElement,\n  positioning: Positioning,\n): void {\n  const style = stickyElem.style;\n  const rootElementRect = positioning.rootElementRect;\n  const rectLeft = rootElementRect !== null ? rootElementRect.left : 0;\n  const rectTop = rootElementRect !== null ? rootElementRect.top : 0;\n  style.top = rectTop + positioning.y + 'px';\n  style.left = rectLeft + positioning.x + 'px';\n}\n\nexport default function StickyComponent({\n  x,\n  y,\n  nodeKey,\n  color,\n  caption,\n}: {\n  caption: LexicalEditor;\n  color: 'pink' | 'yellow';\n  nodeKey: NodeKey;\n  x: number;\n  y: number;\n}): JSX.Element {\n  const [editor] = useLexicalComposerContext();\n  const stickyContainerRef = useRef<null | HTMLDivElement>(null);\n  const positioningRef = useRef<Positioning>({\n    isDragging: false,\n    offsetX: 0,\n    offsetY: 0,\n    rootElementRect: null,\n    x: 0,\n    y: 0,\n  });\n  const {isCollabActive} = useCollaborationContext();\n\n  useEffect(() => {\n    const position = positioningRef.current;\n    position.x = x;\n    position.y = y;\n\n    const stickyContainer = stickyContainerRef.current;\n    if (stickyContainer !== null) {\n      positionSticky(stickyContainer, position);\n    }\n  }, [x, y]);\n\n  useLayoutEffect(() => {\n    const position = positioningRef.current;\n    const resizeObserver = new ResizeObserver((entries) => {\n      for (let i = 0; i < entries.length; i++) {\n        const entry = entries[i];\n        const {target} = entry;\n        position.rootElementRect = target.getBoundingClientRect();\n        const stickyContainer = stickyContainerRef.current;\n        if (stickyContainer !== null) {\n          positionSticky(stickyContainer, position);\n        }\n      }\n    });\n\n    const removeRootListener = editor.registerRootListener(\n      (nextRootElem, prevRootElem) => {\n        if (prevRootElem !== null) {\n          resizeObserver.unobserve(prevRootElem);\n        }\n        if (nextRootElem !== null) {\n          resizeObserver.observe(nextRootElem);\n        }\n      },\n    );\n\n    const handleWindowResize = () => {\n      const rootElement = editor.getRootElement();\n      const stickyContainer = stickyContainerRef.current;\n      if (rootElement !== null && stickyContainer !== null) {\n        position.rootElementRect = rootElement.getBoundingClientRect();\n        positionSticky(stickyContainer, position);\n      }\n    };\n\n    window.addEventListener('resize', handleWindowResize);\n\n    return () => {\n      window.removeEventListener('resize', handleWindowResize);\n      removeRootListener();\n    };\n  }, [editor]);\n\n  useEffect(() => {\n    const stickyContainer = stickyContainerRef.current;\n    if (stickyContainer !== null) {\n      // Delay adding transition so we don't trigger the\n      // transition on load of the sticky.\n      setTimeout(() => {\n        stickyContainer.style.setProperty(\n          'transition',\n          'top 0.3s ease 0s, left 0.3s ease 0s',\n        );\n      }, 500);\n    }\n  }, []);\n\n  const handlePointerMove = (event: PointerEvent) => {\n    const stickyContainer = stickyContainerRef.current;\n    const positioning = positioningRef.current;\n    const rootElementRect = positioning.rootElementRect;\n    const zoom = calculateZoomLevel(stickyContainer);\n    if (\n      stickyContainer !== null &&\n      positioning.isDragging &&\n      rootElementRect !== null\n    ) {\n      positioning.x =\n        event.pageX / zoom - positioning.offsetX - rootElementRect.left;\n      positioning.y =\n        event.pageY / zoom - positioning.offsetY - rootElementRect.top;\n      positionSticky(stickyContainer, positioning);\n    }\n  };\n\n  const handlePointerUp = (event: PointerEvent) => {\n    const stickyContainer = stickyContainerRef.current;\n    const positioning = positioningRef.current;\n    if (stickyContainer !== null) {\n      positioning.isDragging = false;\n      stickyContainer.classList.remove('dragging');\n      editor.update(() => {\n        const node = $getNodeByKey(nodeKey);\n        if ($isStickyNode(node)) {\n          node.setPosition(positioning.x, positioning.y);\n        }\n      });\n    }\n    document.removeEventListener('pointermove', handlePointerMove);\n    document.removeEventListener('pointerup', handlePointerUp);\n  };\n\n  const handleDelete = () => {\n    editor.update(() => {\n      const node = $getNodeByKey(nodeKey);\n      if ($isStickyNode(node)) {\n        node.remove();\n      }\n    });\n  };\n\n  const handleColorChange = () => {\n    editor.update(() => {\n      const node = $getNodeByKey(nodeKey);\n      if ($isStickyNode(node)) {\n        node.toggleColor();\n      }\n    });\n  };\n\n  const {historyState} = useSharedHistoryContext();\n\n  return (\n    <div ref={stickyContainerRef} className=\"sticky-note-container\">\n      <div\n        className={`sticky-note ${color}`}\n        onPointerDown={(event) => {\n          const stickyContainer = stickyContainerRef.current;\n          if (\n            stickyContainer == null ||\n            event.button === 2 ||\n            event.target !== stickyContainer.firstChild\n          ) {\n            // Right click or click on editor should not work\n            return;\n          }\n          const stickContainer = stickyContainer;\n          const positioning = positioningRef.current;\n          if (stickContainer !== null) {\n            const {top, left} = stickContainer.getBoundingClientRect();\n            const zoom = calculateZoomLevel(stickContainer);\n            positioning.offsetX = event.clientX / zoom - left;\n            positioning.offsetY = event.clientY / zoom - top;\n            positioning.isDragging = true;\n            stickContainer.classList.add('dragging');\n            document.addEventListener('pointermove', handlePointerMove);\n            document.addEventListener('pointerup', handlePointerUp);\n            event.preventDefault();\n          }\n        }}>\n        <button\n          onClick={handleDelete}\n          className=\"delete\"\n          aria-label=\"Delete sticky note\"\n          title=\"Delete\">\n          X\n        </button>\n        <button\n          onClick={handleColorChange}\n          className=\"color\"\n          aria-label=\"Change sticky note color\"\n          title=\"Color\">\n          <i className=\"bucket\" />\n        </button>\n        <LexicalNestedComposer\n          initialEditor={caption}\n          initialTheme={StickyEditorTheme}>\n          {isCollabActive ? (\n            <CollaborationPlugin\n              id={caption.getKey()}\n              providerFactory={createWebsocketProvider}\n              shouldBootstrap={true}\n            />\n          ) : (\n            <HistoryPlugin externalHistoryState={historyState} />\n          )}\n          <PlainTextPlugin\n            contentEditable={\n              <ContentEditable\n                placeholder=\"What's up?\"\n                placeholderClassName=\"StickyNode__placeholder\"\n                className=\"StickyNode__contentEditable\"\n              />\n            }\n            ErrorBoundary={LexicalErrorBoundary}\n          />\n        </LexicalNestedComposer>\n      </div>\n    </div>\n  );\n}\n"],"names":["theme","baseTheme","positionSticky","stickyElem","positioning","style","rootElementRect","rectLeft","rectTop","StickyComponent","x","y","nodeKey","color","caption","editor","useLexicalComposerContext","stickyContainerRef","useRef","positioningRef","isCollabActive","useCollaborationContext","useEffect","position","stickyContainer","useLayoutEffect","resizeObserver","entries","i","entry","target","removeRootListener","nextRootElem","prevRootElem","handleWindowResize","rootElement","handlePointerMove","event","zoom","calculateZoomLevel","handlePointerUp","node","$getNodeByKey","$isStickyNode","handleDelete","handleColorChange","historyState","useSharedHistoryContext","jsx","jsxs","stickContainer","top","left","LexicalNestedComposer","StickyEditorTheme","CollaborationPlugin","createWebsocketProvider","HistoryPlugin","PlainTextPlugin","ContentEditable","LexicalErrorBoundary"],"mappings":"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"}